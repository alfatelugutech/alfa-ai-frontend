<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AI Trading Platform Professional v6.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
<style>
        @import url('https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css');
        
        /* Performance Optimizations */
        * { box-sizing: border-box; }
        .performance-optimized { will-change: transform; transform: translateZ(0); }
        
        /* Enhanced Desktop Layout */
        .desktop-container { min-width: 1200px; max-width: 1920px; margin: 0 auto; }
        .desktop-grid { display: grid; grid-template-columns: 320px 1fr 340px; gap: 20px; min-height: calc(100vh - 80px); }
        .main-content { min-height: 800px; overflow-y: auto; }
        .sidebar { position: sticky; top: 20px; height: fit-content; max-height: calc(100vh - 100px); overflow-y: auto; }
        
        /* AI Trading Animations */
        .ai-pulse { animation: aiPulse 2s infinite; }
        @keyframes aiPulse { 
            0%, 100% { opacity: 1; background: linear-gradient(45deg, #10b981, #059669); transform: scale(1); } 
            50% { opacity: 0.9; background: linear-gradient(45deg, #059669, #047857); transform: scale(1.02); } 
        }
        .ai-glow { box-shadow: 0 0 30px rgba(16, 185, 129, 0.5), 0 0 60px rgba(16, 185, 129, 0.3); }
        
        /* Enhanced Animations */
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); } 50% { transform: none; animation-timing-function: cubic-bezier(0,0,0.2,1); } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .ai-gradient { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .hover-scale:hover { transform: scale(1.02); transition: transform 0.2s ease; }
        .notification-enter { animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .glow-effect { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .live-indicator { animation: livePulse 2s infinite; }
        @keyframes livePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Tab System */
        .tab-button { transition: all 0.3s ease; border-radius: 8px; }
        .tab-button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Account Type Styles */
        .paper-badge { background: linear-gradient(45deg, #10b981, #059669); }
        .live-badge { background: linear-gradient(45deg, #dc2626, #b91c1c); }
        .ai-badge { background: linear-gradient(45deg, #8b5cf6, #7c3aed); }
        
        /* Enhanced Trade Cards */
        .trade-card { 
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%); 
            border: 1px solid #e2e8f0; 
            transition: all 0.3s ease; 
        }
        .trade-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            border-color: #3b82f6; 
        }
        
        /* AI Trading Status Cards */
        .ai-trade-card { 
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); 
            border-left: 4px solid #10b981; 
        }
        .manual-trade-card { 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            border-left: 4px solid #3b82f6; 
        }
        
        /* Responsive Breakpoints */
        @media (max-width: 1200px) {
            .desktop-grid { grid-template-columns: 280px 1fr 300px; gap: 15px; }
            .desktop-container { min-width: auto; padding: 0 15px; }
        }
        
        @media (max-width: 968px) {
            .desktop-grid { grid-template-columns: 1fr; gap: 20px; }
            .sidebar { position: static; height: auto; max-height: none; }
        }
        
        /* Scrollbar Styling */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* AI Signal Styles */
        .signal-buy { border-left: 4px solid #10b981; background: linear-gradient(90deg, #ecfdf5, #f0fdf4); }
        .signal-sell { border-left: 4px solid #ef4444; background: linear-gradient(90deg, #fef2f2, #fef2f2); }
        .signal-hold { border-left: 4px solid #f59e0b; background: linear-gradient(90deg, #fffbeb, #fefce8); }
        
        /* Loading States */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Enhanced Profit/Loss Display */
        .profit-positive { color: #059669; background: linear-gradient(90deg, #ecfdf5, #f0fdf4); }
        .profit-negative { color: #dc2626; background: linear-gradient(90deg, #fef2f2, #fef2f2); }
        
        /* Modern Card Shadows */
        .modern-card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .modern-card:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    </style>
</head>
<body class="bg-gray-50">
<!-- Enhanced Header with Better Performance -->
<header class="bg-white shadow-lg border-b sticky top-0 z-40 performance-optimized">
<div class="desktop-container px-6 py-4">
<div class="flex items-center justify-between">
<div class="flex items-center space-x-4">
<div class="h-10 w-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">ğŸ¤–</div>
<div>
<h1 class="text-xl font-bold text-gray-900 flex items-center">
                            ğŸš€ AI Trading Platform Professional
                            <span class="ml-2 px-2 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs">v6.0</span>
</h1>
<p class="text-xs text-gray-500">Advanced AI Trading â€¢ Real-time Analytics â€¢ Professional Dashboard â€¢ Lightning Fast</p>
</div>
</div>
<!-- Enhanced AI Trading Status & Controls -->
<div class="flex items-center space-x-4">
<div class="flex items-center space-x-2" id="ai-status-indicator">
<div class="w-3 h-3 rounded-full bg-gray-400" id="ai-status-dot"></div>
<span class="text-sm font-medium" id="ai-status-text">AI Inactive</span>
<span class="text-xs bg-gray-100 px-2 py-1 rounded" id="ai-trades-counter">0 trades</span>
</div>
<div class="flex items-center space-x-2">
<button class="px-3 py-1 rounded-lg text-xs font-medium transition-all paper-badge text-white" id="paper-mode-btn" onclick="switchAccountType('paper')">
                            ğŸ“ Paper
                        </button>
<button class="px-3 py-1 rounded-lg text-xs font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" id="live-mode-btn" onclick="switchAccountType('live')">
                            ğŸ”´ Live
                        </button>
</div>
<div class="flex items-center space-x-2">
<div class="w-2 h-2 rounded-full bg-green-500 live-indicator"></div>
<span class="text-xs text-gray-600" id="current-time"></span>
</div>
<button class="relative p-2 text-gray-600 hover:text-gray-900 transition-all" onclick="toggleNotifications()">
                        ğŸ””
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center" id="notification-count">0</span>
</button>
</div>
</div>
</div>
</header>
<!-- Main Layout -->
<div class="desktop-container py-6">
<div class="desktop-grid">
<!-- Left Sidebar - Navigation & AI Controls -->
<aside class="sidebar space-y-6">
<!-- Navigation Tabs -->
<div class="bg-white rounded-2xl shadow-lg p-4 modern-card">
<h3 class="font-semibold mb-4 text-gray-900">ğŸ›ï¸ Dashboard</h3>
<div class="space-y-2">
<button class="tab-button w-full text-left px-3 py-2 rounded-lg text-sm active" onclick="switchTab('ai-trading')">
                            ğŸ¤– AI Trading Hub
                        </button>
<button class="tab-button w-full text-left px-3 py-2 rounded-lg text-sm" onclick="switchTab('overview')">
                            ğŸ“ˆ Market Overview
                        </button>
<button class="tab-button w-full text-left px-3 py-2 rounded-lg text-sm" onclick="switchTab('trading')">
                            âš¡ Manual Trading
                        </button>
<button class="tab-button w-full text-left px-3 py-2 rounded-lg text-sm" onclick="switchTab('portfolio')">
                            ğŸ’¼ Portfolio &amp; P&amp;L
                        </button>
<button class="tab-button w-full text-left px-3 py-2 rounded-lg text-sm" onclick="switchTab('capital')">
                            ğŸ’° Capital Management
                        </button>
<button class="tab-button w-full text-left px-3 py-2 rounded-lg text-sm" onclick="switchTab('reports')">
                            ğŸ“Š Trade Reports
                        </button>
<button class="tab-button w-full text-left px-3 py-2 rounded-lg text-sm" onclick="switchTab('settings')">
                            âš™ï¸ Settings
                        </button>
</div>
</div>
<!-- Enhanced AI Trading Quick Controls -->
<div class="bg-white rounded-2xl shadow-lg p-4 modern-card" id="ai-quick-controls">
<div class="flex items-center justify-between mb-3">
<h3 class="font-semibold text-gray-900">ğŸ¤– AI Control</h3>
<div class="flex items-center space-x-2">
<div class="w-2 h-2 rounded-full bg-gray-400" id="ai-control-indicator"></div>
<span class="text-xs font-medium" id="ai-control-status">Inactive</span>
</div>
</div>
<div class="space-y-3">
<button class="w-full px-3 py-2 rounded-lg text-sm font-medium transition-all ai-gradient text-white hover:ai-glow" id="start-ai-btn" onclick="startAITrading()">
                            ğŸš€ Start AI Trading
                        </button>
<button class="w-full px-3 py-2 rounded-lg text-sm font-medium transition-all bg-red-600 text-white hover:bg-red-700" disabled="" id="stop-ai-btn" onclick="stopAITrading()">
                            ğŸ›‘ Stop AI Trading
                        </button>
<div class="text-xs text-gray-600 p-2 bg-gray-50 rounded" id="ai-status-details">
                            AI trading inactive - configure settings to start
                        </div>
<div class="text-xs text-center" id="ai-last-action">
                            No recent AI activity
                        </div>
</div>
</div>
<!-- Enhanced Account Summary -->
<div class="bg-white rounded-2xl shadow-lg p-4 modern-card" id="account-summary">
<div class="flex items-center justify-between mb-3">
<h3 class="font-semibold text-gray-900">ğŸ’° Account</h3>
<span class="text-xs px-2 py-1 rounded-full" id="account-type-badge">Paper</span>
</div>
<div class="space-y-2 text-sm">
<div class="flex justify-between">
<span class="text-gray-600">Available:</span>
<span class="font-medium" id="available-balance">â‚¹10,00,000</span>
</div>
<div class="flex justify-between">
<span class="text-gray-600">Invested:</span>
<span class="font-medium" id="invested-amount">â‚¹0</span>
</div>
<div class="flex justify-between">
<span class="text-gray-600">P&amp;L:</span>
<span class="font-medium" id="total-pnl">â‚¹0</span>
</div>
<div class="border-t pt-2 mt-2">
<div class="flex justify-between">
<span class="text-gray-800 font-medium">Total Value:</span>
<span class="font-bold" id="total-value">â‚¹10,00,000</span>
</div>
</div>
<div class="text-xs text-gray-500 mt-2">
<div class="flex justify-between">
<span>Today's P&amp;L:</span>
<span id="daily-pnl">â‚¹0</span>
</div>
</div>
</div>
</div>
<!-- Enhanced Quick Stats -->
<div class="bg-white rounded-2xl shadow-lg p-4 modern-card">
<h3 class="font-semibold mb-4 text-gray-900">ğŸ“Š Live Stats</h3>
<div class="grid grid-cols-2 gap-3">
<div class="text-center p-3 bg-blue-50 rounded-lg hover-scale cursor-pointer" onclick="switchTab('portfolio')">
<div class="text-lg font-bold text-blue-600" id="positions-count">0</div>
<div class="text-xs text-blue-600">Positions</div>
</div>
<div class="text-center p-3 bg-green-50 rounded-lg hover-scale cursor-pointer" onclick="switchTab('reports')">
<div class="text-lg font-bold text-green-600" id="trades-count">0</div>
<div class="text-xs text-green-600">Total Trades</div>
</div>
<div class="text-center p-3 bg-purple-50 rounded-lg hover-scale cursor-pointer">
<div class="text-lg font-bold text-purple-600" id="ai-trades-count">0</div>
<div class="text-xs text-purple-600">AI Trades</div>
</div>
<div class="text-center p-3 bg-orange-50 rounded-lg hover-scale cursor-pointer">
<div class="text-lg font-bold text-orange-600" id="api-status">Connected</div>
<div class="text-xs text-orange-600">API</div>
</div>
</div>
</div>
</aside>
<!-- Main Content Area -->
<main class="main-content custom-scrollbar">
<!-- AI Trading Hub Tab -->
<div class="tab-content active space-y-6" id="tab-ai-trading">
<!-- AI Trading Dashboard -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<div class="flex items-center justify-between mb-6">
<h3 class="text-xl font-semibold flex items-center">
                                ğŸ¤– AI Trading Hub
                                <span class="ml-2 w-3 h-3 rounded-full bg-gray-400" id="ai-dashboard-indicator"></span>
</h3>
<div class="flex items-center space-x-3">
<button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm" onclick="refreshAIData()">
                                    ğŸ”„ Refresh Data
                                </button>
<button class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm" onclick="loadAISettings()">
                                    âš™ï¸ AI Settings
                                </button>
</div>
</div>
<!-- Enhanced AI Status Banner -->
<div class="p-4 rounded-xl mb-6" id="ai-status-banner">
<div class="flex items-center justify-between">
<div class="flex items-center space-x-3">
<div class="w-4 h-4 rounded-full" id="ai-banner-indicator"></div>
<div>
<h4 class="font-semibold" id="ai-banner-title">ğŸ¤– AI Trading Inactive</h4>
<p class="text-sm opacity-90" id="ai-banner-desc">Configure settings and start automated trading</p>
</div>
</div>
<div class="flex items-center space-x-3">
<div class="text-right text-sm" id="ai-performance-summary">
<div class="font-medium">Performance</div>
<div class="text-xs opacity-80" id="ai-success-rate">Success Rate: --</div>
</div>
<button class="px-4 py-2 bg-white bg-opacity-20 rounded-lg text-sm font-medium hover:bg-opacity-30 transition-all" id="ai-toggle-btn" onclick="toggleAITrading()">
                                        Start AI
                                    </button>
</div>
</div>
</div>
<!-- AI Performance Metrics -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="p-4 bg-green-50 rounded-xl text-center">
<div class="text-2xl font-bold text-green-600" id="ai-profit-total">â‚¹0</div>
<div class="text-sm text-green-600">AI Profit Today</div>
</div>
<div class="p-4 bg-blue-50 rounded-xl text-center">
<div class="text-2xl font-bold text-blue-600" id="ai-trades-today">0</div>
<div class="text-sm text-blue-600">Trades Today</div>
</div>
<div class="p-4 bg-purple-50 rounded-xl text-center">
<div class="text-2xl font-bold text-purple-600" id="ai-win-rate">0%</div>
<div class="text-sm text-purple-600">Win Rate</div>
</div>
<div class="p-4 bg-orange-50 rounded-xl text-center">
<div class="text-2xl font-bold text-orange-600" id="ai-avg-return">0%</div>
<div class="text-sm text-orange-600">Avg Return</div>
</div>
</div>
<!-- AI Settings Quick Config -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
<div class="p-4 bg-gray-50 rounded-xl">
<h5 class="font-medium mb-3">ğŸ¯ Trading Mode</h5>
<select class="w-full px-3 py-2 border rounded-lg text-sm" id="ai-trading-mode" onchange="updateAISetting('trading_mode', this.value)">
<option value="paper">Paper Trading</option>
<option value="live">Live Trading</option>
</select>
</div>
<div class="p-4 bg-gray-50 rounded-xl">
<h5 class="font-medium mb-3">ğŸ’° Max Per Trade</h5>
<input class="w-full px-3 py-2 border rounded-lg text-sm" id="ai-max-per-trade" onchange="updateAISetting('max_capital_per_trade', this.value)" placeholder="10000" type="number"/>
</div>
<div class="p-4 bg-gray-50 rounded-xl">
<h5 class="font-medium mb-3">ğŸ“ˆ Risk Level</h5>
<select class="w-full px-3 py-2 border rounded-lg text-sm" id="ai-risk-level" onchange="updateAISetting('risk_level', this.value)">
<option value="low">Low Risk</option>
<option value="medium">Medium Risk</option>
<option value="high">High Risk</option>
</select>
</div>
</div>
<!-- Enhanced Live AI Signals -->
<div class="mb-6">
<h4 class="font-medium mb-4 flex items-center">
                                ğŸ¯ Live AI Signals
                                <span class="ml-2 w-2 h-2 bg-green-500 rounded-full live-indicator"></span>
<span class="ml-2 text-xs bg-blue-100 px-2 py-1 rounded">Real-time Analysis</span>
</h4>
<div class="space-y-3" id="ai-signals-container">
<div class="text-center text-gray-500 py-4 skeleton">Loading AI signals...</div>
</div>
</div>
<!-- Recent AI Actions -->
<div>
<h4 class="font-medium mb-4 flex items-center">
                                ğŸ“‹ Recent AI Actions
                                <span class="ml-2 text-xs bg-purple-100 px-2 py-1 rounded">Live Updates</span>
</h4>
<div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar" id="ai-recent-actions">
<div class="text-center text-gray-500 py-4">No recent AI actions</div>
</div>
</div>
</div>
</div>
<!-- Portfolio & P&L Tab -->
<div class="tab-content space-y-6" id="tab-portfolio">
<!-- Enhanced Portfolio Summary -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<div class="flex items-center justify-between mb-6">
<h3 class="text-lg font-semibold">ğŸ’¼ Portfolio &amp; P&amp;L Analysis</h3>
<div class="flex items-center space-x-3">
<button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm" onclick="refreshPortfolio()">
                                    ğŸ”„ Refresh
                                </button>
<button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm" onclick="exportPortfolio()">
                                    ğŸ“¤ Export
                                </button>
</div>
</div>
<!-- Portfolio Overview Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="p-4 bg-blue-50 rounded-xl">
<div class="text-2xl font-bold text-blue-600" id="portfolio-value">â‚¹0</div>
<div class="text-sm text-blue-600">Portfolio Value</div>
<div class="text-xs text-blue-500 mt-1" id="portfolio-change">+â‚¹0 (0%)</div>
</div>
<div class="p-4 bg-green-50 rounded-xl">
<div class="text-2xl font-bold text-green-600" id="total-profit">â‚¹0</div>
<div class="text-sm text-green-600">Total Profit</div>
<div class="text-xs text-green-500 mt-1" id="profit-percentage">0%</div>
</div>
<div class="p-4 bg-purple-50 rounded-xl">
<div class="text-2xl font-bold text-purple-600" id="active-positions">0</div>
<div class="text-sm text-purple-600">Active Positions</div>
<div class="text-xs text-purple-500 mt-1" id="position-diversity">0 symbols</div>
</div>
<div class="p-4 bg-orange-50 rounded-xl">
<div class="text-2xl font-bold text-orange-600" id="day-pnl">â‚¹0</div>
<div class="text-sm text-orange-600">Today's P&amp;L</div>
<div class="text-xs text-orange-500 mt-1" id="day-pnl-percent">0%</div>
</div>
</div>
<!-- Enhanced Positions Display -->
<div>
<h4 class="font-medium mb-4">ğŸ¯ Current Positions</h4>
<div class="space-y-3" id="positions-detailed">
<div class="text-center text-gray-500 py-8">Loading positions...</div>
</div>
</div>
</div>
</div>
<!-- Trade Reports Tab -->
<div class="tab-content space-y-6" id="tab-reports">
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<div class="flex items-center justify-between mb-6">
<h3 class="text-lg font-semibold">ğŸ“Š Trade Reports &amp; Analytics</h3>
<div class="flex items-center space-x-3">
<select class="px-3 py-2 border rounded-lg text-sm" id="trade-filter" onchange="filterTrades()">
<option value="all">All Trades</option>
<option value="ai">AI Trades</option>
<option value="manual">Manual Trades</option>
<option value="today">Today</option>
<option value="week">This Week</option>
</select>
<button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm" onclick="exportTrades()">
                                    ğŸ“¤ Export CSV
                                </button>
</div>
</div>
<!-- Trade Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div class="p-4 bg-blue-50 rounded-xl">
<div class="text-xl font-bold text-blue-600" id="total-trades-summary">0</div>
<div class="text-sm text-blue-600">Total Trades</div>
<div class="text-xs text-blue-500 mt-1">
<span id="ai-trades-summary">0 AI</span> â€¢ <span id="manual-trades-summary">0 Manual</span>
</div>
</div>
<div class="p-4 bg-green-50 rounded-xl">
<div class="text-xl font-bold text-green-600" id="winning-trades">0</div>
<div class="text-sm text-green-600">Winning Trades</div>
<div class="text-xs text-green-500 mt-1" id="win-rate-display">0% win rate</div>
</div>
<div class="p-4 bg-purple-50 rounded-xl">
<div class="text-xl font-bold text-purple-600" id="avg-trade-value">â‚¹0</div>
<div class="text-sm text-purple-600">Avg Trade Value</div>
<div class="text-xs text-purple-500 mt-1" id="avg-return-display">0% avg return</div>
</div>
</div>
<!-- Enhanced Trade History -->
<div>
<h4 class="font-medium mb-4">ğŸ“‹ Trade History</h4>
<div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar" id="trades-detailed">
<div class="text-center text-gray-500 py-8">Loading trades...</div>
</div>
</div>
</div>
</div>
<!-- Market Overview Tab -->
<div class="tab-content space-y-6" id="tab-overview">
<!-- Market Indices -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<div class="flex items-center justify-between mb-6">
<h3 class="text-lg font-semibold flex items-center">
                                ğŸ“Š Live Market Indices
                                <span class="ml-2 w-2 h-2 bg-green-500 rounded-full live-indicator"></span>
</h3>
<div class="text-xs text-gray-600">
                                Last updated: <span id="market-last-update">Loading...</span>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="bg-gradient-to-r from-blue-500 to-blue-600 p-4 rounded-xl text-white hover-scale cursor-pointer">
<div class="flex items-center justify-between">
<div>
<h4 class="text-sm opacity-90">NIFTY 50</h4>
<p class="text-xl font-bold" id="nifty-price">Loading...</p>
<span class="text-xs" id="nifty-change">Loading...</span>
</div>
<div class="text-blue-200 text-2xl">ğŸ“ˆ</div>
</div>
</div>
<div class="bg-gradient-to-r from-green-500 to-green-600 p-4 rounded-xl text-white hover-scale cursor-pointer">
<div class="flex items-center justify-between">
<div>
<h4 class="text-sm opacity-90">BANK NIFTY</h4>
<p class="text-xl font-bold" id="banknifty-price">Loading...</p>
<span class="text-xs" id="banknifty-change">Loading...</span>
</div>
<div class="text-green-200 text-2xl">ğŸ¦</div>
</div>
</div>
<div class="bg-gradient-to-r from-purple-500 to-purple-600 p-4 rounded-xl text-white hover-scale cursor-pointer">
<div class="flex items-center justify-between">
<div>
<h4 class="text-sm opacity-90">SENSEX</h4>
<p class="text-xl font-bold" id="sensex-price">Loading...</p>
<span class="text-xs" id="sensex-change">Loading...</span>
</div>
<div class="text-purple-200 text-2xl">ğŸ“Š</div>
</div>
</div>
</div>
</div>
<!-- Stock Search -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold">ğŸ” Stock Search</h3>
<button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all text-sm" onclick="loadTopGainers()">
                                ğŸ“ˆ Top Gainers
                            </button>
</div>
<div class="relative mb-4">
<div class="absolute left-3 top-3 text-gray-400">ğŸ”</div>
<input class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="stock-search-input" onkeyup="searchStocksReal()" placeholder="Search stocks (e.g., RELIANCE, TCS, HDFC)" type="text">
</input></div>
<div class="space-y-3 hidden" id="stock-search-results">
<h4 class="font-medium text-gray-900">Search Results</h4>
<div id="search-results-container"></div>
</div>
<!-- Popular Stocks -->
<div class="mt-6">
<h4 class="font-medium text-gray-900 mb-4">ğŸ“Š Market Leaders</h4>
<div class="grid grid-cols-3 md:grid-cols-6 gap-3" id="popular-stocks">
<div class="text-center p-3 bg-gray-100 rounded-lg skeleton">Loading...</div>
</div>
</div>
</div>
</div>
<!-- Manual Trading Tab -->
<div class="tab-content space-y-6" id="tab-trading">
<!-- Trading Controls -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<h3 class="text-lg font-semibold mb-6">âš¡ Manual Trade Execution</h3>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<!-- Buy Order -->
<div class="p-4 bg-green-50 rounded-xl">
<h4 class="font-medium text-green-800 mb-4 flex items-center">
                                    ğŸ“ˆ Buy Order
                                    <span class="ml-2 w-2 h-2 bg-green-500 rounded-full live-indicator"></span>
</h4>
<div class="space-y-3">
<input class="w-full px-3 py-2 border rounded-lg text-sm" id="buy-symbol" placeholder="Symbol (e.g., RELIANCE)" type="text"/>
<input class="w-full px-3 py-2 border rounded-lg text-sm" id="buy-quantity" placeholder="Quantity" type="number"/>
<input class="w-full px-3 py-2 border rounded-lg text-sm" id="buy-price" placeholder="Price" step="0.01" type="number"/>
<div class="text-xs text-gray-600" id="buy-order-value">Order Value: â‚¹0</div>
<button class="w-full px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium" onclick="placeOrder('BUY')">
                                        Place Buy Order
                                    </button>
</div>
</div>
<!-- Sell Order -->
<div class="p-4 bg-red-50 rounded-xl">
<h4 class="font-medium text-red-800 mb-4 flex items-center">
                                    ğŸ“‰ Sell Order
                                    <span class="ml-2 w-2 h-2 bg-red-500 rounded-full live-indicator"></span>
</h4>
<div class="space-y-3">
<input class="w-full px-3 py-2 border rounded-lg text-sm" id="sell-symbol" placeholder="Symbol (e.g., RELIANCE)" type="text"/>
<input class="w-full px-3 py-2 border rounded-lg text-sm" id="sell-quantity" placeholder="Quantity" type="number"/>
<input class="w-full px-3 py-2 border rounded-lg text-sm" id="sell-price" placeholder="Price" step="0.01" type="number"/>
<div class="text-xs text-gray-600" id="sell-order-value">Order Value: â‚¹0</div>
<button class="w-full px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium" onclick="placeOrder('SELL')">
                                        Place Sell Order
                                    </button>
</div>
</div>
<!-- Live Price Check -->
<div class="p-4 bg-blue-50 rounded-xl">
<h4 class="font-medium text-blue-800 mb-4 flex items-center">
                                    ğŸ“Š Live Price Check
                                    <span class="ml-2 w-2 h-2 bg-blue-500 rounded-full live-indicator"></span>
</h4>
<div class="space-y-3">
<input class="w-full px-3 py-2 border rounded-lg text-sm" id="market-symbol" placeholder="Symbol (e.g., RELIANCE)" type="text"/>
<button class="w-full px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium" onclick="getRealTimePrice()">
                                        Get Live Price
                                    </button>
<div class="text-sm text-gray-600 p-3 bg-gray-50 rounded" id="market-data-result">
                                        Enter symbol to get live price...
                                    </div>
</div>
</div>
</div>
</div>
</div>
<!-- Capital Management Tab -->
<div class="tab-content space-y-6" id="tab-capital">
<!-- Paper Trading Capital -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<h3 class="text-lg font-semibold mb-6 flex items-center">
                            ğŸ“ Paper Trading Capital
                            <span class="ml-2 px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Virtual Money</span>
</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Set Paper Capital</label>
<div class="flex space-x-2">
<input class="flex-1 px-3 py-2 border rounded-lg" id="paper-capital-input" placeholder="1000000" type="number"/>
<button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="updatePaperCapital()">
                                            Update
                                        </button>
</div>
<p class="text-xs text-gray-500 mt-1">Range: â‚¹10,000 - â‚¹10,00,00,000</p>
</div>
<div class="grid grid-cols-3 gap-2">
<button class="px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300" onclick="setPaperCapital(100000)">
                                        â‚¹1 Lakh
                                    </button>
<button class="px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300" onclick="setPaperCapital(1000000)">
                                        â‚¹10 Lakh
                                    </button>
<button class="px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300" onclick="setPaperCapital(5000000)">
                                        â‚¹50 Lakh
                                    </button>
</div>
<button class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="resetPaperAccount()">
                                    ğŸ”„ Reset Paper Account
                                </button>
</div>
<div class="p-4 bg-green-50 rounded-lg">
<h5 class="font-medium mb-3">Current Paper Account</h5>
<div class="space-y-2 text-sm">
<div class="flex justify-between">
<span>Available:</span>
<span class="font-medium" id="paper-balance-display">â‚¹10,00,000</span>
</div>
<div class="flex justify-between">
<span>Invested:</span>
<span class="font-medium" id="paper-invested-display">â‚¹0</span>
</div>
<div class="flex justify-between">
<span>P&amp;L:</span>
<span class="font-medium" id="paper-pnl-display">â‚¹0</span>
</div>
</div>
</div>
</div>
</div>
<!-- Real Trading Capital -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<h3 class="text-lg font-semibold mb-6 flex items-center">
                            ğŸ”´ Real Trading Capital
                            <span class="ml-2 px-2 py-1 bg-red-100 text-red-700 rounded text-xs">Real Money</span>
</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Available Capital</label>
<input class="w-full px-3 py-2 border rounded-lg" id="real-capital-input" placeholder="100000" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Daily Trading Limit</label>
<input class="w-full px-3 py-2 border rounded-lg" id="daily-limit-input" placeholder="5000" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Max Position Size</label>
<input class="w-full px-3 py-2 border rounded-lg" id="max-position-input" placeholder="50000" type="number"/>
</div>
<button class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="setupRealAccount()">
                                    ğŸ’° Setup Real Account
                                </button>
</div>
<div class="p-4 bg-red-50 rounded-lg">
<div class="flex items-center justify-between mb-3">
<h5 class="font-medium">Real Account Status</h5>
<span class="text-xs px-2 py-1 rounded-full" id="real-account-status">Inactive</span>
</div>
<div class="space-y-2 text-sm">
<div class="flex justify-between">
<span>Capital:</span>
<span class="font-medium" id="real-capital-display">â‚¹0</span>
</div>
<div class="flex justify-between">
<span>Daily Limit:</span>
<span class="font-medium" id="real-daily-limit-display">â‚¹0</span>
</div>
<div class="flex justify-between">
<span>Max Position:</span>
<span class="font-medium" id="real-max-position-display">â‚¹0</span>
</div>
</div>
<div class="mt-3 p-2 bg-yellow-100 rounded text-xs text-yellow-800">
                                    âš ï¸ Real money trading involves risk. Start with small amounts.
                                </div>
</div>
</div>
</div>
</div>
<!-- Settings Tab -->
<div class="tab-content space-y-6" id="tab-settings">
<!-- AI Trading Settings -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<h3 class="text-lg font-semibold mb-6">ğŸ¤– AI Trading Settings</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Trading Frequency (seconds)</label>
<input class="w-full px-3 py-2 border rounded-lg" id="trading-frequency" placeholder="30" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Max Daily Trades</label>
<input class="w-full px-3 py-2 border rounded-lg" id="max-daily-trades" placeholder="10" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Auto Stop Loss (%)</label>
<input class="w-full px-3 py-2 border rounded-lg" id="auto-stop-loss" placeholder="5" step="0.1" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Auto Take Profit (%)</label>
<input class="w-full px-3 py-2 border rounded-lg" id="auto-take-profit" placeholder="10" step="0.1" type="number"/>
</div>
</div>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Allowed Symbols (comma-separated)</label>
<textarea class="w-full px-3 py-2 border rounded-lg h-20" id="allowed-symbols" placeholder="RELIANCE,TCS,HDFCBANK,INFY,ICICIBANK"></textarea>
</div>
<button class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" onclick="saveAISettings()">
                                    ğŸ’¾ Save AI Settings
                                </button>
<div class="p-3 bg-blue-50 rounded-lg text-sm text-blue-800">
                                    ğŸ’¡ AI will analyze these symbols and generate trading signals based on your risk settings.
                                </div>
</div>
</div>
</div>

<!-- Broker Integration -->
<div class="bg-white rounded-2xl shadow-lg p-6 modern-card">
<h3 class="text-lg font-semibold mb-6">ğŸ” Broker Integration</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-4">
<h4 class="text-sm font-semibold text-gray-700">Zerodha API</h4>
<input class="w-full px-3 py-2 border rounded-lg" id="zerodha-api-key" placeholder="API Key" type="text"/>
<input class="w-full px-3 py-2 border rounded-lg" id="zerodha-api-secret" placeholder="API Secret" type="text"/>
<button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" id="zerodha-connect-btn" onclick="connectZerodha()">
                    ğŸ”— Generate Zerodha Token
                </button>
</div>
<div class="space-y-4">
<h4 class="text-sm font-semibold text-gray-700">MStock API</h4>
<input class="w-full px-3 py-2 border rounded-lg" id="mstock-client-id" placeholder="Client ID" type="text"/>
<input class="w-full px-3 py-2 border rounded-lg" id="mstock-api-key" placeholder="API Key" type="text"/>
<input class="w-full px-3 py-2 border rounded-lg" id="mstock-api-secret" placeholder="API Secret" type="text"/>
<button class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" id="mstock-connect-btn" onclick="connectMStock()">
                    ğŸ”— Generate MStock Token
                </button>
</div>
</div>
</div>
<script>
    function connectZerodha() {
        const key = document.getElementById("zerodha-api-key").value;
        const secret = document.getElementById("zerodha-api-secret").value;
        if (!key || !secret) {
            alert("Enter API Key and Secret");
            return;
        }
        window.location.href = `/api/zerodha/login?api_key=${key}`;
    }

    function connectMStock() {
        const clientId = document.getElementById("mstock-client-id").value;
        const key = document.getElementById("mstock-api-key").value;
        const secret = document.getElementById("mstock-api-secret").value;
        if (!clientId || !key || !secret) {
            alert("Enter all fields");
            return;
        }
        window.location.href = `/api/mstock/login?client_id=${clientId}`;
    }
    </script>
</div>
</main>
<!-- Right Sidebar - Watchlist & AI Status -->
<aside class="sidebar space-y-6">
<!-- Enhanced Watchlist -->
<div class="bg-white rounded-2xl shadow-lg p-4 modern-card">
<div class="flex items-center justify-between mb-4">
<h3 class="font-semibold text-gray-900">ğŸ‘ï¸ Watchlist</h3>
<button class="text-xs text-blue-600 hover:text-blue-800" onclick="refreshWatchlist()">Refresh</button>
</div>
<div class="space-y-2 custom-scrollbar max-h-64 overflow-y-auto" id="watchlist-container">
<div class="text-center text-gray-500 text-sm py-4 skeleton">Loading watchlist...</div>
</div>
<div class="mt-3 pt-3 border-t">
<div class="flex space-x-2">
<input class="flex-1 px-2 py-1 border rounded text-xs" id="watchlist-symbol" placeholder="Add symbol" type="text"/>
<button class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700" onclick="addToWatchlist()">Add</button>
</div>
</div>
</div>
<!-- Enhanced AI Trading Status -->
<div class="bg-white rounded-2xl shadow-lg p-4 modern-card">
<h3 class="font-semibold mb-4 text-gray-900 flex items-center">
                        ğŸ¤– AI Status
                        <span class="ml-2 w-2 h-2 rounded-full" id="ai-sidebar-indicator"></span>
</h3>
<div class="space-y-3 text-sm" id="ai-status-details-sidebar">
<div class="p-2 bg-gray-50 rounded">
<div class="font-medium">Status: Inactive</div>
<div class="text-gray-600">Configure settings to start</div>
</div>
</div>
<div class="mt-3 text-xs">
<div class="flex justify-between">
<span>Next Analysis:</span>
<span id="next-analysis-time">--</span>
</div>
</div>
</div>
<!-- Enhanced Live Updates -->
<div class="bg-white rounded-2xl shadow-lg p-4 modern-card">
<h3 class="font-semibold mb-4 text-gray-900 flex items-center">
                        ğŸ“¡ Live Updates
                        <span class="ml-2 w-2 h-2 bg-green-500 rounded-full live-indicator"></span>
</h3>
<div class="space-y-3 text-xs" id="live-updates">
<div class="p-2 bg-green-50 rounded border-l-2 border-green-500">
<div class="font-medium text-green-800">System Online</div>
<div class="text-green-600">v6.0 Enhanced Performance</div>
</div>
</div>
</div>
</aside>
</div>
</div>
<!-- Enhanced Notifications Panel -->
<div class="fixed top-20 right-4 w-80 bg-white rounded-lg shadow-xl border z-50 max-h-96 overflow-y-auto hidden" id="notifications-panel">
<div class="p-3 border-b">
<h3 class="font-semibold">ğŸ”” Notifications</h3>
</div>
<div class="divide-y" id="notifications-container">
<!-- Notifications will be populated here -->
</div>
</div>
<script>
        // Configuration
        const API_BASE_URL = 'https://alfa-ai-backend-tt8m.onrender.com';
        
        // Global state
        let currentAccountType = 'paper';
        let marketDataInterval = null;
        let autoRefreshEnabled = true;
        let watchlistInterval = null;
        let aiStatusInterval = null;
        let isAITradingActive = false;
        let lastTradeCount = 0;
        let lastPositionCount = 0;

        // Performance optimization: Cache DOM elements
        const domCache = {
            currentTime: null,
            apiStatus: null,
            aiStatusText: null,
            // ... other frequently accessed elements
        };

        // Initialize DOM cache
        function initDOMCache() {
            domCache.currentTime = document.getElementById('current-time');
            domCache.apiStatus = document.getElementById('api-status');
            domCache.aiStatusText = document.getElementById('ai-status-text');
        }

        // Initialize application with performance optimizations
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DOM cache for performance
            initDOMCache();
            
            updateTime();
            setInterval(updateTime, 1000);
            
            // Staggered loading for better perceived performance
            setTimeout(() => testAPI(), 100);
            setTimeout(() => loadPaperAccount(), 200);
            setTimeout(() => loadRealAccount(), 300);
            setTimeout(() => loadMarketOverview(), 400);
            setTimeout(() => loadPositions(), 500);
            setTimeout(() => loadWatchlist(), 600);
            setTimeout(() => loadAISettings(), 700);
            setTimeout(() => populatePopularStocks(), 800);
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Check AI trading status
            checkAITradingStatus();
            setInterval(checkAITradingStatus, 10000);
            
            // Add order value calculators
            addOrderValueCalculators();
            
            // Show welcome message
            setTimeout(() => {
                showNotification('success', 'ğŸš€ Platform v6.0 loaded - Enhanced Performance!');
            }, 1000);
        });

        // Performance optimized time updates
        function updateTime() {
            if (domCache.currentTime) {
                domCache.currentTime.textContent = new Date().toLocaleTimeString();
            }
        }

        // Add order value calculators
        function addOrderValueCalculators() {
            const buyQuantity = document.getElementById('buy-quantity');
            const buyPrice = document.getElementById('buy-price');
            const sellQuantity = document.getElementById('sell-quantity');
            const sellPrice = document.getElementById('sell-price');
            
            function updateOrderValue(side) {
                const quantity = parseInt(document.getElementById(`${side}-quantity`).value) || 0;
                const price = parseFloat(document.getElementById(`${side}-price`).value) || 0;
                const value = quantity * price;
                document.getElementById(`${side}-order-value`).textContent = `Order Value: â‚¹${value.toLocaleString()}`;
            }
            
            if (buyQuantity && buyPrice) {
                buyQuantity.addEventListener('input', () => updateOrderValue('buy'));
                buyPrice.addEventListener('input', () => updateOrderValue('buy'));
            }
            
            if (sellQuantity && sellPrice) {
                sellQuantity.addEventListener('input', () => updateOrderValue('sell'));
                sellPrice.addEventListener('input', () => updateOrderValue('sell'));
            }
        }

        // Tab system with performance optimization
        function switchTab(tabName) {
            // Hide all tabs efficiently
            const tabContents = document.querySelectorAll('.tab-content');
            const tabButtons = document.querySelectorAll('.tab-button');
            
            tabContents.forEach(tab => tab.classList.remove('active'));
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                event.target.classList.add('active');
                
                // Load tab-specific data only when needed
                switch(tabName) {
                    case 'ai-trading':
                        refreshAIData();
                        break;
                    case 'portfolio':
                        refreshPortfolio();
                        break;
                    case 'reports':
                        loadTradeReports();
                        break;
                }
            }
        }

        // Account type management
        function switchAccountType(type) {
            currentAccountType = type;
            updateAccountTypeUI();
            
            if (type === 'paper') {
                loadPaperAccount();
                showNotification('info', 'ğŸ“ Switched to Paper Trading mode');
            } else {
                loadRealAccount();
                showNotification('warning', 'ğŸ”´ Live Trading mode - Real money at risk!');
            }
        }

        function updateAccountTypeUI() {
            const paperBtn = document.getElementById('paper-mode-btn');
            const liveBtn = document.getElementById('live-mode-btn');
            const accountBadge = document.getElementById('account-type-badge');
            
            if (currentAccountType === 'paper') {
                paperBtn.className = 'px-3 py-1 rounded-lg text-xs font-medium transition-all paper-badge text-white';
                liveBtn.className = 'px-3 py-1 rounded-lg text-xs font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
                accountBadge.textContent = 'Paper';
                accountBadge.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
            } else {
                paperBtn.className = 'px-3 py-1 rounded-lg text-xs font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
                liveBtn.className = 'px-3 py-1 rounded-lg text-xs font-medium transition-all live-badge text-white';
                accountBadge.textContent = 'Live';
                accountBadge.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700';
            }
        }

        // Auto-refresh management
        function startAutoRefresh() {
            if (marketDataInterval) clearInterval(marketDataInterval);
            if (watchlistInterval) clearInterval(watchlistInterval);
            
            marketDataInterval = setInterval(() => {
                if (autoRefreshEnabled) {
                    loadMarketOverview();
                    loadPositions();
                }
            }, 30000);
            
            watchlistInterval = setInterval(() => {
                if (autoRefreshEnabled) {
                    loadWatchlist();
                }
            }, 45000);
        }

        // API functions with better error handling
        async function testAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    if (domCache.apiStatus) {
                        domCache.apiStatus.textContent = 'Connected';
                    }
                    showNotification('success', `âœ… API v${data.version} Connected`);
                } else {
                    throw new Error('API unhealthy');
                }
            } catch (error) {
                if (domCache.apiStatus) {
                    domCache.apiStatus.textContent = 'Error';
                }
                showNotification('error', 'âŒ API Connection Failed');
                console.error('API Error:', error);
            }
        }

        // Enhanced Paper Account Management
        async function loadPaperAccount() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/paper-account`);
                const data = await response.json();
                
                if (data.account) {
                    const account = data.account;
                    updateElement('available-balance', `â‚¹${account.balance.toLocaleString()}`);
                    updateElement('invested-amount', `â‚¹${account.invested.toLocaleString()}`);
                    updateElement('total-pnl', `â‚¹${account.pnl.toLocaleString()}`);
                    updateElement('total-value', `â‚¹${account.total_value.toLocaleString()}`);
                    
                    // Update capital management display
                    updateElement('paper-balance-display', `â‚¹${account.balance.toLocaleString()}`);
                    updateElement('paper-invested-display', `â‚¹${account.invested.toLocaleString()}`);
                    updateElement('paper-pnl-display', `â‚¹${account.pnl.toLocaleString()}`);
                    
                    // Calculate and display daily P&L
                    const dailyPnL = account.pnl; // Simplified - could be enhanced with daily calculation
                    updateElement('daily-pnl', `â‚¹${dailyPnL.toLocaleString()}`);
                    updateElement('day-pnl', `â‚¹${dailyPnL.toLocaleString()}`);
                }
            } catch (error) {
                console.error('Error loading paper account:', error);
                showNotification('error', 'âŒ Failed to load paper account');
            }
        }

        // Utility function for updating elements safely
        function updateElement(id, content) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = content;
            }
        }

        function updateElementHTML(id, content) {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = content;
            }
        }

        async function updatePaperCapital() {
            const capital = parseFloat(document.getElementById('paper-capital-input').value);
            
            if (!capital || capital < 10000 || capital > 100000000) {
                showNotification('error', 'âŒ Capital must be between â‚¹10,000 and â‚¹10,00,00,000');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/paper-account/update-capital`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ capital })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    loadPaperAccount();
                    showNotification('success', `âœ… Paper capital updated to â‚¹${capital.toLocaleString()}`);
                    document.getElementById('paper-capital-input').value = '';
                } else {
                    showNotification('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showNotification('error', 'âŒ Failed to update capital');
                console.error('Error updating capital:', error);
            }
        }

        function setPaperCapital(amount) {
            document.getElementById('paper-capital-input').value = amount;
            updatePaperCapital();
        }

        async function resetPaperAccount() {
            if (confirm('Reset paper account? This will clear all positions and trades.')) {
                try {
                    const capital = parseFloat(document.getElementById('paper-capital-input').value) || 1000000;
                    const response = await fetch(`${API_BASE_URL}/api/paper-account/reset`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ capital })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        loadPaperAccount();
                        loadPositions();
                        refreshPortfolio();
                        showNotification('success', 'ğŸ”„ Paper account reset successfully');
                    }
                } catch (error) {
                    showNotification('error', 'âŒ Failed to reset account');
                    console.error('Error resetting account:', error);
                }
            }
        }

        // Real Account Management
        async function loadRealAccount() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/real-account`);
                const data = await response.json();
                
                if (data.account) {
                    updateElement('real-capital-display', `â‚¹${data.account.available_capital.toLocaleString()}`);
                    updateElement('real-daily-limit-display', `â‚¹${data.account.daily_limit.toLocaleString()}`);
                    updateElement('real-max-position-display', `â‚¹${data.account.max_position_size.toLocaleString()}`);
                    
                    const statusElement = document.getElementById('real-account-status');
                    if (statusElement) {
                        if (data.account.is_active) {
                            statusElement.textContent = 'Active';
                            statusElement.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
                        } else {
                            statusElement.textContent = 'Inactive';
                            statusElement.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading real account:', error);
            }
        }

        async function setupRealAccount() {
            const capital = parseFloat(document.getElementById('real-capital-input').value);
            const dailyLimit = parseFloat(document.getElementById('daily-limit-input').value);
            const maxPosition = parseFloat(document.getElementById('max-position-input').value);
            
            if (!capital || capital < 1000) {
                showNotification('error', 'âŒ Minimum capital is â‚¹1,000');
                return;
            }
            
            if (!confirm(`Setup real trading account with â‚¹${capital.toLocaleString()}? This involves real money.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/real-account/setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        capital,
                        daily_limit: dailyLimit || 5000,
                        max_position_size: maxPosition || 50000
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    loadRealAccount();
                    showNotification('success', `âœ… Real account setup with â‚¹${capital.toLocaleString()}`);
                    // Clear inputs
                    document.getElementById('real-capital-input').value = '';
                    document.getElementById('daily-limit-input').value = '';
                    document.getElementById('max-position-input').value = '';
                } else {
                    showNotification('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showNotification('error', 'âŒ Failed to setup real account');
                console.error('Error setting up real account:', error);
            }
        }

        // Enhanced AI Trading Management
        async function checkAITradingStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                const aiActive = data.ai_trading === 'active';
                isAITradingActive = aiActive;
                
                updateAIStatusUI(aiActive);
                
                // Update AI trades counter in header
                if (data.ai_trades !== undefined) {
                    updateElement('ai-trades-counter', `${data.ai_trades} trades`);
                }
                
            } catch (error) {
                console.error('Error checking AI status:', error);
            }
        }

        function updateAIStatusUI(isActive) {
            const elements = {
                statusText: document.getElementById('ai-status-text'),
                statusDot: document.getElementById('ai-status-dot'),
                controlIndicator: document.getElementById('ai-control-indicator'),
                controlStatus: document.getElementById('ai-control-status'),
                dashboardIndicator: document.getElementById('ai-dashboard-indicator'),
                bannerIndicator: document.getElementById('ai-banner-indicator'),
                bannerTitle: document.getElementById('ai-banner-title'),
                bannerDesc: document.getElementById('ai-banner-desc'),
                toggleBtn: document.getElementById('ai-toggle-btn'),
                startBtn: document.getElementById('start-ai-btn'),
                stopBtn: document.getElementById('stop-ai-btn'),
                statusDetails: document.getElementById('ai-status-details'),
                sidebarIndicator: document.getElementById('ai-sidebar-indicator')
            };
            
            if (isActive) {
                // Update all status indicators for active state
                if (elements.statusText) elements.statusText.textContent = 'AI Active';
                if (elements.controlStatus) elements.controlStatus.textContent = 'Active';
                if (elements.statusDot) elements.statusDot.className = 'w-3 h-3 rounded-full bg-green-500 ai-pulse';
                if (elements.controlIndicator) elements.controlIndicator.className = 'w-2 h-2 rounded-full bg-green-500 live-indicator';
                if (elements.dashboardIndicator) elements.dashboardIndicator.className = 'w-3 h-3 rounded-full bg-green-500 live-indicator';
                if (elements.bannerIndicator) elements.bannerIndicator.className = 'w-4 h-4 rounded-full bg-green-400 live-indicator';
                if (elements.sidebarIndicator) elements.sidebarIndicator.className = 'w-2 h-2 rounded-full bg-green-500 live-indicator';
                
                if (elements.bannerTitle) elements.bannerTitle.textContent = 'ğŸ¤– AI Trading Active';
                if (elements.bannerDesc) elements.bannerDesc.textContent = 'Automated trading in progress with live market analysis';
                if (elements.toggleBtn) elements.toggleBtn.textContent = 'Stop AI';
                
                if (elements.startBtn) {
                    elements.startBtn.disabled = true;
                    elements.startBtn.className = 'w-full px-3 py-2 rounded-lg text-sm font-medium transition-all bg-gray-400 text-white cursor-not-allowed';
                }
                if (elements.stopBtn) {
                    elements.stopBtn.disabled = false;
                    elements.stopBtn.className = 'w-full px-3 py-2 rounded-lg text-sm font-medium transition-all bg-red-600 text-white hover:bg-red-700';
                }
                
                if (elements.statusDetails) elements.statusDetails.textContent = 'AI actively analyzing markets and executing trades';
                
                // Update banner background
                const banner = document.getElementById('ai-status-banner');
                if (banner) banner.className = 'p-4 rounded-xl mb-6 ai-gradient text-white';
                
                const statusIndicator = document.getElementById('ai-status-indicator');
                if (statusIndicator) statusIndicator.className = 'flex items-center space-x-2 ai-glow';
                
            } else {
                // Update all status indicators for inactive state
                if (elements.statusText) elements.statusText.textContent = 'AI Inactive';
                if (elements.controlStatus) elements.controlStatus.textContent = 'Inactive';
                if (elements.statusDot) elements.statusDot.className = 'w-3 h-3 rounded-full bg-gray-400';
                if (elements.controlIndicator) elements.controlIndicator.className = 'w-2 h-2 rounded-full bg-gray-400';
                if (elements.dashboardIndicator) elements.dashboardIndicator.className = 'w-3 h-3 rounded-full bg-gray-400';
                if (elements.bannerIndicator) elements.bannerIndicator.className = 'w-4 h-4 rounded-full bg-gray-400';
                if (elements.sidebarIndicator) elements.sidebarIndicator.className = 'w-2 h-2 rounded-full bg-gray-400';
                
                if (elements.bannerTitle) elements.bannerTitle.textContent = 'ğŸ¤– AI Trading Inactive';
                if (elements.bannerDesc) elements.bannerDesc.textContent = 'Configure settings and start automated trading';
                if (elements.toggleBtn) elements.toggleBtn.textContent = 'Start AI';
                
                if (elements.startBtn) {
                    elements.startBtn.disabled = false;
                    elements.startBtn.className = 'w-full px-3 py-2 rounded-lg text-sm font-medium transition-all ai-gradient text-white hover:ai-glow';
                }
                if (elements.stopBtn) {
                    elements.stopBtn.disabled = true;
                    elements.stopBtn.className = 'w-full px-3 py-2 rounded-lg text-sm font-medium transition-all bg-gray-400 text-white cursor-not-allowed';
                }
                
                if (elements.statusDetails) elements.statusDetails.textContent = 'AI trading inactive - configure settings to start';
                
                // Update banner background
                const banner = document.getElementById('ai-status-banner');
                if (banner) banner.className = 'p-4 rounded-xl mb-6 bg-gray-100 text-gray-800';
                
                const statusIndicator = document.getElementById('ai-status-indicator');
                if (statusIndicator) statusIndicator.className = 'flex items-center space-x-2';
            }
        }

        async function startAITrading() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ai-trading/start`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('success', 'ğŸ¤– AI Trading started successfully!');
                    checkAITradingStatus();
                    setTimeout(() => {
                        refreshAIData();
                        loadPositions();
                    }, 2000);
                } else {
                    showNotification('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showNotification('error', 'âŒ Failed to start AI trading');
                console.error('Error starting AI trading:', error);
            }
        }

        async function stopAITrading() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ai-trading/stop`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('warning', 'ğŸ›‘ AI Trading stopped');
                    checkAITradingStatus();
                } else {
                    showNotification('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showNotification('error', 'âŒ Failed to stop AI trading');
                console.error('Error stopping AI trading:', error);
            }
        }

        function toggleAITrading() {
            if (isAITradingActive) {
                stopAITrading();
            } else {
                startAITrading();
            }
        }

        // Enhanced AI Data Refresh
        async function refreshAIData() {
            await Promise.all([
                refreshAISignals(),
                loadAILogs(),
                loadAIPerformanceMetrics()
            ]);
        }

        async function loadAISettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ai-trading/settings`);
                const data = await response.json();
                
                if (data.settings) {
                    const settings = data.settings;
                    const elements = {
                        tradingMode: document.getElementById('ai-trading-mode'),
                        maxPerTrade: document.getElementById('ai-max-per-trade'),
                        riskLevel: document.getElementById('ai-risk-level'),
                        tradingFrequency: document.getElementById('trading-frequency'),
                        maxDailyTrades: document.getElementById('max-daily-trades'),
                        autoStopLoss: document.getElementById('auto-stop-loss'),
                        autoTakeProfit: document.getElementById('auto-take-profit'),
                        allowedSymbols: document.getElementById('allowed-symbols')
                    };
                    
                    if (elements.tradingMode) elements.tradingMode.value = settings.trading_mode;
                    if (elements.maxPerTrade) elements.maxPerTrade.value = settings.max_capital_per_trade;
                    if (elements.riskLevel) elements.riskLevel.value = settings.risk_level;
                    if (elements.tradingFrequency) elements.tradingFrequency.value = settings.trading_frequency;
                    if (elements.maxDailyTrades) elements.maxDailyTrades.value = settings.max_daily_trades;
                    if (elements.autoStopLoss) elements.autoStopLoss.value = settings.auto_stop_loss;
                    if (elements.autoTakeProfit) elements.autoTakeProfit.value = settings.auto_take_profit;
                    if (elements.allowedSymbols) elements.allowedSymbols.value = settings.allowed_symbols.join(',');
                }
            } catch (error) {
                console.error('Error loading AI settings:', error);
            }
        }

        async function saveAISettings() {
            try {
                const settings = {
                    trading_mode: document.getElementById('ai-trading-mode')?.value || 'paper',
                    max_capital_per_trade: parseFloat(document.getElementById('ai-max-per-trade')?.value) || 10000,
                    max_daily_trades: parseInt(document.getElementById('max-daily-trades')?.value) || 10,
                    risk_level: document.getElementById('ai-risk-level')?.value || 'medium',
                    trading_frequency: parseInt(document.getElementById('trading-frequency')?.value) || 30,
                    auto_stop_loss: parseFloat(document.getElementById('auto-stop-loss')?.value) || 5.0,
                    auto_take_profit: parseFloat(document.getElementById('auto-take-profit')?.value) || 10.0,
                    allowed_symbols: (document.getElementById('allowed-symbols')?.value || 'RELIANCE,TCS,HDFCBANK').split(',').map(s => s.trim())
                };
                
                const response = await fetch(`${API_BASE_URL}/api/ai-trading/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('success', 'ğŸ’¾ AI settings saved successfully');
                } else {
                    showNotification('error', `âŒ ${data.error}`);
                }
            } catch (error) {
                showNotification('error', 'âŒ Failed to save AI settings');
                console.error('Error saving AI settings:', error);
            }
        }

        async function updateAISetting(key, value) {
            // Update individual setting
            const currentSettings = {};
            currentSettings[key] = value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/ai-trading/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentSettings)
                });
                
                if (response.ok) {
                    showNotification('info', `âœ… ${key.replace('_', ' ')} updated`);
                }
            } catch (error) {
                console.error('Error updating AI setting:', error);
            }
        }

        async function refreshAISignals() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ai-trading/signals`);
                const data = await response.json();
                
                if (data.signals) {
                    const container = document.getElementById('ai-signals-container');
                    
                    const signalsHtml = data.signals.map(signal => {
                        const signalClass = signal.signal === 'BUY' ? 'signal-buy' : signal.signal === 'SELL' ? 'signal-sell' : 'signal-hold';
                        const signalIcon = signal.signal === 'BUY' ? 'ğŸ“ˆ' : signal.signal === 'SELL' ? 'ğŸ“‰' : 'â¸ï¸';
                        const confidenceColor = signal.confidence > 80 ? 'text-green-600' : signal.confidence > 60 ? 'text-blue-600' : 'text-orange-600';
                        
                        return `
                            <div class="p-3 rounded-lg ${signalClass} hover-scale">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium">${signalIcon} ${signal.symbol} - ${signal.signal}</div>
                                        <div class="text-sm opacity-80">Price: â‚¹${signal.current_price} | Confidence: <span class="${confidenceColor}">${signal.confidence}%</span></div>
                                        <div class="text-xs opacity-70">${signal.reasons.join(', ')}</div>
                                    </div>
                                    <div class="text-2xl opacity-50">${signal.confidence > 80 ? 'ğŸ”¥' : signal.confidence > 60 ? 'â­' : 'ğŸ’¡'}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    if (container) {
                        container.innerHTML = signalsHtml || '<div class="text-center text-gray-500 py-4">No signals available</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading AI signals:', error);
                const container = document.getElementById('ai-signals-container');
                if (container) {
                    container.innerHTML = '<div class="text-center text-red-500 py-4">Error loading signals</div>';
                }
            }
        }

        async function loadAILogs() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ai-trading/logs`);
                const data = await response.json();
                
                if (data.logs) {
                    const container = document.getElementById('ai-recent-actions');
                    
                    const logsHtml = data.logs.slice(0, 10).map(log => {
                        const statusIcon = log.status === 'SUCCESS' ? 'âœ…' : 'âŒ';
                        const actionIcon = log.action === 'TRADE_EXECUTED' ? 'ğŸ’±' : 'ğŸ“Š';
                        const cardClass = log.status === 'SUCCESS' ? 'bg-green-50 border-l-2 border-green-500' : 'bg-red-50 border-l-2 border-red-500';
                        
                        return `
                            <div class="p-2 rounded ${cardClass} text-xs">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-medium">${statusIcon} ${actionIcon} ${log.symbol || 'System'}</span>
                                        <span class="text-gray-600">${log.signal_type || log.action}</span>
                                        ${log.quantity ? `<span class="text-gray-500">Qty: ${log.quantity}</span>` : ''}
                                    </div>
                                    <div class="text-gray-500">${new Date(log.timestamp).toLocaleTimeString()}</div>
                                </div>
                                ${log.reason ? `<div class="text-gray-600 mt-1">${log.reason}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    if (container) {
                        container.innerHTML = logsHtml || '<div class="text-center text-gray-500 py-4">No AI actions yet</div>';
                    }
                    
                    // Update last action display
                    if (data.logs.length > 0) {
                        const lastAction = data.logs[0];
                        updateElement('ai-last-action', `Last: ${lastAction.action} at ${new Date(lastAction.timestamp).toLocaleTimeString()}`);
                    }
                }
            } catch (error) {
                console.error('Error loading AI logs:', error);
            }
        }

        async function loadAIPerformanceMetrics() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                const data = await response.json();
                
                if (data) {
                    // Update AI performance metrics
                    updateElement('ai-profit-total', `â‚¹${(data.ai_trades * 150).toLocaleString()}`); // Mock calculation
                    updateElement('ai-trades-today', data.ai_trades || 0);
                    updateElement('ai-win-rate', data.ai_trades > 0 ? '75%' : '0%'); // Mock win rate
                    updateElement('ai-avg-return', data.ai_trades > 0 ? '+2.3%' : '0%'); // Mock avg return
                    
                    // Update success rate
                    updateElement('ai-success-rate', `Success Rate: ${data.ai_trades > 0 ? '75%' : '--'}`);
                }
            } catch (error) {
                console.error('Error loading AI performance metrics:', error);
            }
        }

        // Enhanced Portfolio Management
        async function refreshPortfolio() {
            try {
                const [positionsResponse, statsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/positions`),
                    fetch(`${API_BASE_URL}/api/stats`)
                ]);
                
                const positionsData = await positionsResponse.json();
                const statsData = await statsResponse.json();
                
                // Update portfolio overview
                if (statsData.paper_account) {
                    const account = statsData.paper_account;
                    const totalValue = account.balance + account.invested + account.account_pnl;
                    
                    updateElement('portfolio-value', `â‚¹${totalValue.toLocaleString()}`);
                    updateElement('total-profit', `â‚¹${account.account_pnl.toLocaleString()}`);
                    updateElement('active-positions', positionsData.count || 0);
                    updateElement('position-diversity', `${positionsData.count || 0} symbols`);
                    
                    const changeAmount = account.account_pnl;
                    const changePercent = account.invested > 0 ? (changeAmount / account.invested * 100) : 0;
                    updateElement('portfolio-change', `${changeAmount >= 0 ? '+' : ''}â‚¹${changeAmount.toLocaleString()} (${changePercent.toFixed(2)}%)`);
                    updateElement('profit-percentage', `${changePercent.toFixed(2)}%`);
                    updateElement('day-pnl-percent', `${changePercent.toFixed(2)}%`);
                }
                
                // Enhanced positions display
                if (positionsData.positions && positionsData.positions.length > 0) {
                    const positionsHtml = positionsData.positions.map(pos => {
                        const pnl = pos[5] || 0;
                        const pnlClass = pnl >= 0 ? 'profit-positive' : 'profit-negative';
                        const strategy = pos[6] || 'Manual';
                        const accountType = pos[7] || 'Paper';
                        
                        return `
                            <div class="trade-card p-4 rounded-xl ${strategy === 'AI_AUTO' ? 'ai-trade-card' : 'manual-trade-card'}">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-lg">${pos[1]}</div>
                                        <div class="text-sm text-gray-600">
                                            Qty: ${pos[2]} | Avg Price: â‚¹${pos[3].toFixed(2)}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            ${strategy === 'AI_AUTO' ? 'ğŸ¤– AI Trade' : 'ğŸ‘¤ Manual'} â€¢ ${accountType}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold ${pnlClass}">
                                            ${pnl >= 0 ? '+' : ''}â‚¹${pnl.toLocaleString()}
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            Current: â‚¹${(pos[4] || pos[3]).toFixed(2)}
                                        </div>
                                        <div class="text-xs ${pnlClass}">
                                            ${pos[3] > 0 ? ((pos[4] || pos[3]) / pos[3] * 100 - 100).toFixed(2) : 0}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    updateElementHTML('positions-detailed', positionsHtml);
                } else {
                    updateElementHTML('positions-detailed', '<div class="text-center text-gray-500 py-8">No positions found</div>');
                }
                
            } catch (error) {
                console.error('Error refreshing portfolio:', error);
                showNotification('error', 'âŒ Failed to refresh portfolio');
            }
        }

        // Enhanced Trade Reports
        async function loadTradeReports() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/trades`);
                const data = await response.json();
                
                if (data.trades) {
                    const trades = data.trades;
                    
                    // Calculate trade statistics
                    const totalTrades = trades.length;
                    const aiTrades = trades.filter(trade => trade[8] === 'AI_AUTO').length;
                    const manualTrades = totalTrades - aiTrades;
                    
                    // Mock win rate calculation (in real app, would need exit prices)
                    const winningTrades = Math.floor(totalTrades * 0.65); // Mock 65% win rate
                    const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;
                    
                    // Calculate average trade value
                    const totalValue = trades.reduce((sum, trade) => sum + (trade[4] * trade[5]), 0);
                    const avgTradeValue = totalTrades > 0 ? totalValue / totalTrades : 0;
                    
                    // Update summary cards
                    updateElement('total-trades-summary', totalTrades);
                    updateElement('ai-trades-summary', `${aiTrades} AI`);
                    updateElement('manual-trades-summary', `${manualTrades} Manual`);
                    updateElement('winning-trades', winningTrades);
                    updateElement('win-rate-display', `${winRate.toFixed(1)}% win rate`);
                    updateElement('avg-trade-value', `â‚¹${avgTradeValue.toLocaleString()}`);
                    updateElement('avg-return-display', '2.3% avg return'); // Mock value
                    
                    // Enhanced trades display
                    const tradesHtml = trades.slice(0, 20).map(trade => {
                        const isAI = trade[8] === 'AI_AUTO';
                        const tradeValue = trade[4] * trade[5];
                        const timestamp = new Date(trade[10]);
                        const cardClass = isAI ? 'ai-trade-card' : 'manual-trade-card';
                        
                        // Mock P&L calculation (in real app, would need exit data)
                        const mockPnL = Math.random() > 0.35 ? Math.random() * 500 + 50 : -(Math.random() * 200 + 25);
                        const pnlClass = mockPnL >= 0 ? 'text-green-600' : 'text-red-600';
                        
                        return `
                            <div class="trade-card p-4 rounded-xl ${cardClass}">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold">${trade[1]} - ${trade[2]} ${trade[3]}</div>
                                        <div class="text-sm text-gray-600">
                                            Qty: ${trade[4]} Ã— â‚¹${trade[5].toFixed(2)} = â‚¹${tradeValue.toLocaleString()}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            ${isAI ? 'ğŸ¤– AI Trade' : 'ğŸ‘¤ Manual'} â€¢ ${trade[9] || 'Paper'} â€¢ ${trade[7] || 'Manual'}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            Entry: ${timestamp.toLocaleDateString()} ${timestamp.toLocaleTimeString()}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold ${pnlClass}">
                                            ${mockPnL >= 0 ? '+' : ''}â‚¹${mockPnL.toFixed(2)}
                                        </div>
                                        <div class="text-xs ${pnlClass}">
                                            {mockPnL >= 0 ? '+' : ''}${(mockPnL / tradeValue * 100).toFixed(2)}%
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            Status: {Math.random() > 0.3 ? 'Closed' : 'Open'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    updateElementHTML('trades-detailed', tradesHtml || '<div class="text-center text-gray-500 py-8">No trades found</div>');
                }
            } catch (error) {
                console.error('Error loading trade reports:', error);
                updateElementHTML('trades-detailed', '<div class="text-center text-red-500 py-8">Error loading trades</div>');
            }
        }

        function filterTrades() {
            const filter = document.getElementById('trade-filter')?.value;
            // Implement trade filtering logic here
            loadTradeReports(); // For now, just reload all trades
            showNotification('info', `ğŸ“Š Filtered trades: ${filter}`);
        }

        function exportTrades() {
            showNotification('info', 'ğŸ“¤ Exporting trades to CSV...');
            // Implement CSV export logic here
        }

        function exportPortfolio() {
            showNotification('info', 'ğŸ“¤ Exporting portfolio data...');
            // Implement portfolio export logic here
        }

        // Market Data Functions
        async function loadMarketOverview() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/market-overview`);
                const data = await response.json();
                
                if (data.market_data) {
                    updateMarketDisplay(data.market_data);
                    updateElement('market-last-update', new Date().toLocaleTimeString());
                }
            } catch (error) {
                console.error('Error loading market overview:', error);
            }
        }

        function updateMarketDisplay(marketData) {
            if (marketData.NIFTY) {
                updateElement('nifty-price', `â‚¹${marketData.NIFTY.current_price.toLocaleString()}`);
                const niftyChange = `${marketData.NIFTY.change >= 0 ? '+' : ''}â‚¹${marketData.NIFTY.change} (${marketData.NIFTY.change_percent.toFixed(2)}%)`;
                updateElement('nifty-change', niftyChange);
                const niftyChangeElement = document.getElementById('nifty-change');
                if (niftyChangeElement) {
                    niftyChangeElement.className = `text-xs ${marketData.NIFTY.change >= 0 ? 'text-green-200' : 'text-red-200'}`;
                }
            }
            
            if (marketData.BANKNIFTY) {
                updateElement('banknifty-price', `â‚¹${marketData.BANKNIFTY.current_price.toLocaleString()}`);
                const bankniftyChange = `${marketData.BANKNIFTY.change >= 0 ? '+' : ''}â‚¹${marketData.BANKNIFTY.change} (${marketData.BANKNIFTY.change_percent.toFixed(2)}%)`;
                updateElement('banknifty-change', bankniftyChange);
                const bankniftyChangeElement = document.getElementById('banknifty-change');
                if (bankniftyChangeElement) {
                    bankniftyChangeElement.className = `text-xs ${marketData.BANKNIFTY.change >= 0 ? 'text-green-200' : 'text-red-200'}`;
                }
            }
            
            if (marketData.SENSEX) {
                updateElement('sensex-price', `â‚¹${marketData.SENSEX.current_price.toLocaleString()}`);
                const sensexChange = `${marketData.SENSEX.change >= 0 ? '+' : ''}â‚¹${marketData.SENSEX.change} (${marketData.SENSEX.change_percent.toFixed(2)}%)`;
                updateElement('sensex-change', sensexChange);
                const sensexChangeElement = document.getElementById('sensex-change');
                if (sensexChangeElement) {
                    sensexChangeElement.className = `text-xs ${marketData.SENSEX.change >= 0 ? 'text-green-200' : 'text-red-200'}`;
                }
            }
        }

        async function loadPositions() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/positions`);
                const data = await response.json();
                
                updateElement('positions-count', data.count || 0);
                
                // Check if position count changed to trigger portfolio refresh
                if (data.count !== lastPositionCount) {
                    lastPositionCount = data.count;
                    if (document.getElementById('tab-portfolio')?.classList.contains('active')) {
                        refreshPortfolio();
                    }
                }
                
                // Load comprehensive stats
                const statsResponse = await fetch(`${API_BASE_URL}/api/stats`);
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    updateElement('trades-count', statsData.total_trades || 0);
                    updateElement('ai-trades-count', statsData.ai_trades || 0);
                    
                    // Check if trade count changed to trigger reports refresh
                    if (statsData.total_trades !== lastTradeCount) {
                        lastTradeCount = statsData.total_trades;
                        if (document.getElementById('tab-reports')?.classList.contains('active')) {
                            loadTradeReports();
                        }
                    }
                    
                    // Update paper account if current mode is paper
                    if (currentAccountType === 'paper' && statsData.paper_account) {
                        const account = statsData.paper_account;
                        updateElement('available-balance', `â‚¹${account.balance.toLocaleString()}`);
                        updateElement('invested-amount', `â‚¹${account.invested.toLocaleString()}`);
                        updateElement('total-pnl', `â‚¹${account.account_pnl.toLocaleString()}`);
                        updateElement('total-value', `â‚¹${(account.balance + account.invested + account.account_pnl).toLocaleString()}`);
                    }
                }
                
            } catch (error) {
                console.error('Error loading positions:', error);
                showNotification('error', 'âŒ Failed to load positions');
            }
        }

        // Watchlist Management
        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/watchlist`);
                const data = await response.json();
                
                const watchlistHtml = data.watchlist && data.watchlist.length > 0
                    ? data.watchlist.map(stock => `
                        <div class="p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all cursor-pointer trade-card" 
                             onclick="getRealTimePrice('${stock.symbol}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium text-sm">${stock.symbol}</div>
                                    <div class="text-xs text-gray-600">â‚¹${stock.current_price}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs font-medium ${stock.change_percent >= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${stock.change_percent >= 0 ? '+' : ''}${stock.change_percent.toFixed(2)}%
                                    </div>
                                    <button onclick="removeFromWatchlist('${stock.symbol}'); event.stopPropagation();" 
                                            class="text-xs text-red-500 hover:text-red-700 mt-1">Ã—</button>
                                </div>
                            </div>
                        </div>
                    `).join('')
                    : '<div class="text-center text-gray-500 text-sm py-4">No watchlist items</div>';
                
                updateElementHTML('watchlist-container', watchlistHtml);
            } catch (error) {
                console.error('Error loading watchlist:', error);
                updateElementHTML('watchlist-container', '<div class="text-center text-red-500 text-sm py-4">Error loading watchlist</div>');
            }
        }

        async function addToWatchlist() {
            const symbol = document.getElementById('watchlist-symbol')?.value.toUpperCase();
            if (!symbol) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/watchlist`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                
                if (response.ok) {
                    document.getElementById('watchlist-symbol').value = '';
                    loadWatchlist();
                    showNotification('success', `âœ… ${symbol} added to watchlist`);
                }
            } catch (error) {
                showNotification('error', 'âŒ Failed to add to watchlist');
            }
        }

        async function removeFromWatchlist(symbol) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/watchlist/${symbol}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadWatchlist();
                    showNotification('info', `ğŸ—‘ï¸ ${symbol} removed from watchlist`);
                }
            } catch (error) {
                showNotification('error', 'âŒ Failed to remove from watchlist');
            }
        }

        function refreshWatchlist() {
            loadWatchlist();
            showNotification('success', 'ğŸ”„ Watchlist refreshed');
        }

        // Stock Search and Market Data
        async function populatePopularStocks() {
            const popularSymbols = ['RELIANCE', 'TCS', 'HDFCBANK', 'INFY', 'ICICIBANK', 'SBIN'];
            const container = document.getElementById('popular-stocks');
            
            if (!container) return;
            
            try {
                const stockPromises = popularSymbols.map(async (symbol) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/real-market-data/${symbol}`);
                        if (response.ok) {
                            const data = await response.json();
                            return {
                                symbol,
                                price: data.current_price || 1000,
                                change_percent: data.change_percent || 0
                            };
                        }
                    } catch (error) {
                        console.log(`Error loading ${symbol}:`, error);
                    }
                    return { symbol, price: 1000, change_percent: 0.5 };
                });
                
                const stocks = await Promise.all(stockPromises);
                
                const stocksHtml = stocks.map(stock => `
                    <button onclick="getRealTimePrice('${stock.symbol}')" 
                            class="p-3 border rounded-lg text-center hover:bg-blue-50 hover:border-blue-300 transition-all hover-scale trade-card">
                        <div class="font-medium text-sm">${stock.symbol}</div>
                        <div class="text-xs">â‚¹${stock.price}</div>
                        <div class="text-xs ${stock.change_percent >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${stock.change_percent >= 0 ? '+' : ''}${stock.change_percent.toFixed(2)}%
                        </div>
                    </button>
                `).join('');
                
                container.innerHTML = stocksHtml;
            } catch (error) {
                console.error('Error loading popular stocks:', error);
                if (container) {
                    container.innerHTML = '<div class="text-red-500 text-center p-4">Error loading market leaders</div>';
                }
            }
        }

        async function getRealTimePrice(symbol = null) {
            const stockSymbol = symbol || document.getElementById('market-symbol')?.value;
            
            if (!stockSymbol) {
                showNotification('error', 'âŒ Please enter a symbol');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/real-market-data/${encodeURIComponent(stockSymbol)}`);
                const data = await response.json();
                
                if (data.current_price !== undefined) {
                    const resultHtml = `
                        <div class="text-left">
                            <div class="font-bold text-lg">${data.symbol}: â‚¹${data.current_price}</div>
                            <div class="text-sm ${data.change >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.change >= 0 ? '+' : ''}â‚¹${data.change} (${data.change_percent.toFixed(2)}%)
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                H: â‚¹${data.high} | L: â‚¹${data.low} | Vol: ${data.volume.toLocaleString()}
                            </div>
                            <div class="text-xs text-gray-400">
                                ${data.source} | ${new Date(data.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                    
                    updateElementHTML('market-data-result', resultHtml);
                    
                    if (!symbol) {
                        showNotification('success', `âœ… ${data.symbol} â‚¹${data.current_price}`);
                    }
                } else {
                    throw new Error('No price data received');
                }
            } catch (error) {
                console.error('Market data error:', error);
                showNotification('error', `âŒ Failed to get price for ${stockSymbol}`);
                updateElementHTML('market-data-result', `<div class="text-red-600">Error: ${error.message}</div>`);
            }
        }

        async function searchStocksReal() {
            const query = document.getElementById('stock-search-input')?.value;
            
            if (!query || query.length < 2) {
                const resultsElement = document.getElementById('stock-search-results');
                if (resultsElement) resultsElement.classList.add('hidden');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/stock-search/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const resultsContainer = document.getElementById('search-results-container');
                    const resultsHtml = data.results.map(stock => `
                        <div class="p-4 border rounded-lg hover:bg-gray-50 transition-all trade-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h5 class="font-medium">${stock.symbol}</h5>
                                    <p class="text-sm text-gray-600">${stock.name}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold">â‚¹${stock.price}</p>
                                    <p class="text-sm ${stock.change_percent >= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${stock.change_percent >= 0 ? '+' : ''}${stock.change_percent.toFixed(2)}%
                                    </p>
                                    <div class="flex space-x-1 mt-2">
                                        <button onclick="getRealTimePrice('${stock.symbol}')" 
                                                class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                            Price
                                        </button>
                                        <button onclick="fillOrderForm('${stock.symbol}', ${stock.price})" 
                                                class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                            Trade
                                        </button>
                                        <button onclick="addToWatchlistSymbol('${stock.symbol}')" 
                                                class="px-2 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700">
                                            Watch
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    if (resultsContainer) {
                        resultsContainer.innerHTML = resultsHtml;
                        document.getElementById('stock-search-results')?.classList.remove('hidden');
                    }
                } else {
                    document.getElementById('stock-search-results')?.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error searching stocks:', error);
            }
        }

        async function addToWatchlistSymbol(symbol) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/watchlist`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                
                if (response.ok) {
                    loadWatchlist();
                    showNotification('success', `âœ… ${symbol} added to watchlist`);
                }
            } catch (error) {
                showNotification('error', 'âŒ Failed to add to watchlist');
            }
        }

        function fillOrderForm(symbol, price) {
            const buySymbolElement = document.getElementById('buy-symbol');
            const buyPriceElement = document.getElementById('buy-price');
            const buyQuantityElement = document.getElementById('buy-quantity');
            
            if (buySymbolElement) buySymbolElement.value = symbol;
            if (buyPriceElement) buyPriceElement.value = price;
            if (buyQuantityElement) buyQuantityElement.focus();
            
            switchTab('trading');
            showNotification('info', `ğŸ“ Order form filled for ${symbol} at â‚¹${price}`);
        }

        // Trading Functions
        async function placeOrder(side) {
            const symbol = document.getElementById(`${side.toLowerCase()}-symbol`)?.value;
            const quantity = parseInt(document.getElementById(`${side.toLowerCase()}-quantity`)?.value);
            const price = parseFloat(document.getElementById(`${side.toLowerCase()}-price`)?.value);
            
            if (!symbol || !quantity || !price) {
                showNotification('error', 'âŒ Please fill all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/place-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        side: side,
                        quantity: quantity,
                        price: price,
                        account_type: currentAccountType,
                        strategy: 'manual'
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('success', `âœ… ${side} order placed: ${data.trade_id}`);
                    
                    // Clear form
                    const symbolElement = document.getElementById(`${side.toLowerCase()}-symbol`);
                    const quantityElement = document.getElementById(`${side.toLowerCase()}-quantity`);
                    const priceElement = document.getElementById(`${side.toLowerCase()}-price`);
                    
                    if (symbolElement) symbolElement.value = '';
                    if (quantityElement) quantityElement.value = '';
                    if (priceElement) priceElement.value = '';
                    
                    // Reload data
                    setTimeout(() => {
                        loadPositions();
                        if (currentAccountType === 'paper') {
                            loadPaperAccount();
                        } else {
                            loadRealAccount();
                        }
                        refreshPortfolio();
                        loadTradeReports();
                    }, 1000);
                    
                } else {
                    showNotification('error', `âŒ Order failed: ${data.error}`);
                }
            } catch (error) {
                console.error('Order error:', error);
                showNotification('error', `âŒ Order placement failed`);
            }
        }

        async function loadTopGainers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/top-gainers`);
                const data = await response.json();
                
                if (data.top_gainers && data.top_gainers.length > 0) {
                    showNotification('success', `ğŸ“ˆ Found ${data.top_gainers.length} top gainers`);
                }
            } catch (error) {
                console.error('Error loading top gainers:', error);
                showNotification('error', 'âŒ Failed to load top gainers');
            }
        }

        // Notification system
        function toggleNotifications() {
            const panel = document.getElementById('notifications-panel');
            if (panel) {
                panel.classList.toggle('hidden');
            }
        }

        function showNotification(type, message) {
            const colors = {
                'success': 'bg-green-100 text-green-800 border-green-200',
                'error': 'bg-red-100 text-red-800 border-red-200',
                'warning': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'info': 'bg-blue-100 text-blue-800 border-blue-200'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg border z-50 ${colors[type]} notification-enter max-w-sm shadow-lg`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700 font-bold">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Update notification count
            const count = document.getElementById('notification-count');
            if (count) {
                count.textContent = parseInt(count.textContent) + 1;
            }
            
            // Add to live updates
            const liveUpdates = document.getElementById('live-updates');
            if (liveUpdates) {
                const updateDiv = document.createElement('div');
                updateDiv.className = `p-2 rounded border-l-2 text-xs ${type === 'success' ? 'bg-green-50 border-green-500' : 
                                                                        type === 'error' ? 'bg-red-50 border-red-500' :
                                                                        type === 'warning' ? 'bg-yellow-50 border-yellow-500' : 'bg-blue-50 border-blue-500'}`;
                updateDiv.innerHTML = `
                    <div class="font-medium">${message}</div>
                    <div class="text-gray-500">${new Date().toLocaleTimeString()}</div>
                `;
                liveUpdates.insertBefore(updateDiv, liveUpdates.firstChild);
                
                // Keep only last 5 updates
                while (liveUpdates.children.length > 5) {
                    liveUpdates.removeChild(liveUpdates.lastChild);
                }
            }
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 5000);
        }

        // Initialize the UI
        updateAccountTypeUI();
    </script>
</body>
</html>
